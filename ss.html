<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laravel Eloquent - Cheatsheet Completa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #ff2d20;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5em;
            border-bottom: 3px solid #ff2d20;
            padding-bottom: 20px;
        }
        
        h2 {
            color: #ff2d20;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 5px solid #ff2d20;
            padding-left: 15px;
        }
        
        h3 {
            color: #e3342f;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .method-block {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .method-title {
            font-weight: bold;
            color: #007bff;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        code {
            background: #f0f0f0;
            color: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid #ddd;
        }
        
        pre {
            background: white;
            color: #333;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            line-height: 1.4;
            border: 1px solid #ddd;
        }
        
        pre code {
            background: none;
            padding: 0;
            border: none;
        }
        
        .pros {
            color: #28a745;
            font-weight: bold;
        }
        
        .cons {
            color: #dc3545;
            font-weight: bold;
        }
        
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .tip {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        th {
            background: #ff2d20;
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #dee2e6;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 20px;
            }
            .method-block {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Laravel Eloquent - Cheatsheet Completa</h1>
        
        <h2>üìö Eager Loading (Caricamento Relazioni)</h2>
        
        <div class="method-block">
            <div class="method-title">with() - Carica Relazioni</div>
            <pre><code>// Carica una relazione
$categories = Category::with('trips')->get();

// Carica pi√π relazioni
$trips = Trip::with('category', 'tags')->get();

// Relazioni annidate
$categories = Category::with('trips.tags')->get();</code></pre>
            <p><span class="pros">‚úÖ PRO:</span> Evita N+1 problem, carica tutti i dati delle relazioni</p>
            <p><span class="cons">‚ùå CONTRO:</span> Pu√≤ essere pesante se non ti servono tutti i dati</p>
            <p><strong>Uso in Blade:</strong> <code>{{ $category->trips }}</code></p>
        </div>

        <div class="method-block">
            <div class="method-title">withCount() - Conta Relazioni</div>
            <pre><code>// Conta una relazione
$categories = Category::withCount('trips')->get();

// Conta pi√π relazioni
$categories = Category::withCount('trips', 'reviews')->get();

// Con filtri
$categories = Category::withCount([
    'trips',
    'trips as expensive_trips_count' => function($query) {
        $query->where('price', '>', 1000);
    }
])->get();</code></pre>
            <p><span class="pros">‚úÖ PRO:</span> Leggerissimo, solo un numero</p>
            <p><span class="cons">‚ùå CONTRO:</span> Non hai accesso ai dati della relazione</p>
            <p><strong>Uso in Blade:</strong> <code>{{ $category->trips_count }}</code></p>
        </div>

        <div class="method-block">
            <div class="method-title">load() - Lazy Eager Loading</div>
            <pre><code>// Carica dopo aver recuperato il model
$category = Category::find(1);
$category->load('trips');

// Carica condizionalmente
if ($needTrips) {
    $category->load('trips');
}</code></pre>
            <p><span class="pros">‚úÖ PRO:</span> Carica solo quando necessario</p>
            <p><strong>Uso:</strong> Quando decidi dopo aver preso il model</p>
        </div>

        <div class="method-block">
            <div class="method-title">loadCount() - Conta dopo il recupero</div>
            <pre><code>$category = Category::find(1);
$category->loadCount('trips');

// Ora hai: $category->trips_count</code></pre>
            <p><strong>Uso:</strong> Come load() ma per i conteggi</p>
        </div>

        <div class="tip">
            <strong>üí° REGOLA D'ORO:</strong><br>
            - Ti serve il <strong>numero</strong>? ‚Üí <code>withCount()</code><br>
            - Ti servono i <strong>dati</strong>? ‚Üí <code>with()</code><br>
            - Ti serve <strong>tutto</strong>? ‚Üí <code>with()</code> e poi <code>->count()</code>
        </div>

        <h2>üîç Query Base</h2>

        <div class="method-block">
            <div class="method-title">Recuperare Dati</div>
            <pre><code>// Tutti i record
$trips = Trip::all();

// Con condizioni
$trips = Trip::get();

// Primo record
$trip = Trip::first();

// Trova per ID
$trip = Trip::find(1);
$trip = Trip::findOrFail(1); // 404 se non trova

// Trova multipli
$trips = Trip::find([1, 2, 3]);</code></pre>
        </div>

        <div class="method-block">
            <div class="method-title">Where - Filtri</div>
            <pre><code>// Where base
Trip::where('price', '>', 100)->get();

// Multipli where
Trip::where('category_id', 1)
    ->where('price', '<', 500)
    ->get();

// Where con OR
Trip::where('category_id', 1)
    ->orWhere('category_id', 2)
    ->get();

// Where In
Trip::whereIn('category_id', [1, 2, 3])->get();

// Where Between
Trip::whereBetween('price', [100, 500])->get();

// Where Null
Trip::whereNull('deleted_at')->get();

// Where Date
Trip::whereDate('start_date', '2025-10-12')->get();
Trip::whereYear('start_date', 2025)->get();
Trip::whereMonth('start_date', 10)->get();</code></pre>
        </div>

        <div class="method-block">
            <div class="method-title">Ordinamento e Limitazione</div>
            <pre><code>// Order By
Trip::orderBy('price', 'desc')->get();
Trip::orderBy('title', 'asc')->get();

// Latest / Oldest (by created_at)
Trip::latest()->get();
Trip::oldest()->get();

// Limit e Skip
Trip::take(10)->get();
Trip::skip(5)->take(10)->get();

// Paginazione
Trip::paginate(15);
Trip::simplePaginate(15);</code></pre>
        </div>

        <h2>‚úçÔ∏è CRUD Operations</h2>

        <div class="method-block">
            <div class="method-title">Create - Creare Record</div>
            <pre><code>// Metodo 1: New + Save
$trip = new Trip();
$trip->title = 'Viaggio a Roma';
$trip->destination = 'Roma';
$trip->price = 500;
$trip->save();

// Metodo 2: Create (richiede $fillable)
$trip = Trip::create([
    'title' => 'Viaggio a Roma',
    'destination' => 'Roma',
    'price' => 500
]);

// firstOrCreate - Trova o crea
$trip = Trip::firstOrCreate(
    ['title' => 'Viaggio a Roma'],
    ['destination' => 'Roma', 'price' => 500]
);</code></pre>
        </div>

        <div class="method-block">
            <div class="method-title">Update - Aggiornare Record</div>
            <pre><code>// Metodo 1: Find + Save
$trip = Trip::find(1);
$trip->price = 600;
$trip->save();

// Metodo 2: Update (richiede $fillable)
$trip = Trip::find(1);
$trip->update(['price' => 600]);

// Update multipli
Trip::where('category_id', 1)
    ->update(['price' => 500]);</code></pre>
        </div>

        <div class="method-block">
            <div class="method-title">Delete - Eliminare Record</div>
            <pre><code>// Metodo 1: Find + Delete
$trip = Trip::find(1);
$trip->delete();

// Metodo 2: Destroy
Trip::destroy(1);
Trip::destroy([1, 2, 3]);

// Delete con condizioni
Trip::where('price', '>', 1000)->delete();</code></pre>
        </div>

        <h2>üîó Relazioni</h2>

        <h3>One to Many (1 a Molti)</h3>
        
        <div class="comparison">
            <div class="comparison-item">
                <strong>Model Category</strong>
                <pre><code>public function trips()
{
    return $this->hasMany(Trip::class);
}</code></pre>
            </div>
            <div class="comparison-item">
                <strong>Model Trip</strong>
                <pre><code>public function category()
{
    return $this->belongsTo(Category::class);
}</code></pre>
            </div>
        </div>

        <div class="method-block">
            <div class="method-title">Uso Relazioni 1-a-Molti</div>
            <pre><code>// Accedere ai viaggi di una categoria
$category = Category::find(1);
$trips = $category->trips;

// Accedere alla categoria di un viaggio
$trip = Trip::find(1);
$category = $trip->category;

// Query con relazioni
$category->trips()->where('price', '>', 500)->get();

// Creare viaggio per una categoria
$category->trips()->create([
    'title' => 'Nuovo Viaggio',
    'price' => 300
]);</code></pre>
        </div>

        <h3>Many to Many (Molti a Molti)</h3>

        <div class="comparison">
            <div class="comparison-item">
                <strong>Model Trip</strong>
                <pre><code>public function tags()
{
    return $this->belongsToMany(Tag::class);
}</code></pre>
            </div>
            <div class="comparison-item">
                <strong>Model Tag</strong>
                <pre><code>public function trips()
{
    return $this->belongsToMany(Trip::class);
}</code></pre>
            </div>
        </div>

        <div class="method-block">
            <div class="method-title">Uso Relazioni Molti-a-Molti</div>
            <pre><code>// Accedere ai tag di un viaggio
$trip = Trip::find(1);
$tags = $trip->tags;

// Attach - Collegare
$trip->tags()->attach($tagId);
$trip->tags()->attach([1, 2, 3]);

// Detach - Scollegare
$trip->tags()->detach($tagId);
$trip->tags()->detach([1, 2, 3]);
$trip->tags()->detach(); // Scollega tutti

// Sync - Sincronizzare
$trip->tags()->sync([1, 2, 3]); // Sostituisce tutto

// Toggle - Attiva/Disattiva
$trip->tags()->toggle($tagId);</code></pre>
        </div>

        <h2>üìä Aggregazioni</h2>

        <div class="method-block">
            <div class="method-title">Funzioni di Aggregazione</div>
            <pre><code>// Count - Contare
$count = Trip::count();
$count = Trip::where('category_id', 1)->count();

// Sum - Somma
$total = Trip::sum('price');

// Average - Media
$avg = Trip::avg('price');

// Max e Min
$max = Trip::max('price');
$min = Trip::min('price');

// Exists - Verificare esistenza
$exists = Trip::where('title', 'Roma')->exists();

// doesntExist
$notExists = Trip::where('title', 'Marte')->doesntExist();</code></pre>
        </div>

        <h2>üéØ Query Avanzate</h2>

        <div class="method-block">
            <div class="method-title">Relazioni con Condizioni</div>
            <pre><code>// whereHas - Filtra per relazioni
$categories = Category::whereHas('trips', function($query) {
    $query->where('price', '>', 500);
})->get();

// with + where
$categories = Category::with(['trips' => function($query) {
    $query->where('price', '>', 500);
}])->get();

// has - Ha almeno una relazione
$categories = Category::has('trips')->get();

// has con conteggio
$categories = Category::has('trips', '>=', 5)->get();</code></pre>
        </div>

        <div class="method-block">
            <div class="method-title">Select Personalizzato</div>
            <pre><code>// Select specifico
Trip::select('id', 'title', 'price')->get();

// Select Raw
Trip::selectRaw('COUNT(*) as total, category_id')
    ->groupBy('category_id')
    ->get();

// Distinct
Trip::distinct()->pluck('destination');</code></pre>
        </div>

        <h2>üìã Tabella Riepilogativa</h2>

        <table>
            <thead>
                <tr>
                    <th>Metodo</th>
                    <th>Uso</th>
                    <th>Esempio</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>all()</code></td>
                    <td>Tutti i record</td>
                    <td><code>Trip::all()</code></td>
                </tr>
                <tr>
                    <td><code>find()</code></td>
                    <td>Trova per ID</td>
                    <td><code>Trip::find(1)</code></td>
                </tr>
                <tr>
                    <td><code>where()</code></td>
                    <td>Filtra risultati</td>
                    <td><code>Trip::where('price', '>', 100)</code></td>
                </tr>
                <tr>
                    <td><code>with()</code></td>
                    <td>Carica relazioni</td>
                    <td><code>Category::with('trips')</code></td>
                </tr>
                <tr>
                    <td><code>withCount()</code></td>
                    <td>Conta relazioni</td>
                    <td><code>Category::withCount('trips')</code></td>
                </tr>
                <tr>
                    <td><code>create()</code></td>
                    <td>Crea record</td>
                    <td><code>Trip::create([...])</code></td>
                </tr>
                <tr>
                    <td><code>update()</code></td>
                    <td>Aggiorna record</td>
                    <td><code>$trip->update([...])</code></td>
                </tr>
                <tr>
                    <td><code>delete()</code></td>
                    <td>Elimina record</td>
                    <td><code>$trip->delete()</code></td>
                </tr>
                <tr>
                    <td><code>paginate()</code></td>
                    <td>Paginazione</td>
                    <td><code>Trip::paginate(15)</code></td>
                </tr>
                <tr>
                    <td><code>orderBy()</code></td>
                    <td>Ordina risultati</td>
                    <td><code>Trip::orderBy('price', 'desc')</code></td>
                </tr>
            </tbody>
        </table>

        <div class="note">
            <strong>‚ö†Ô∏è N+1 Problem</strong><br>
            Evita loop con query dentro:
            <pre><code>// ‚ùå MALE - N+1 Problem
@foreach($categories as $category)
    {{ $category->trips->count() }} // Query ad ogni iterazione!
@endforeach

// ‚úÖ BENE - Una sola query
$categories = Category::withCount('trips')->get();
@foreach($categories as $category)
    {{ $category->trips_count }}
@endforeach</code></pre>
        </div>

        <div class="tip">
            <strong>üöÄ Performance Tips</strong><br>
            1. Usa sempre <code>with()</code> o <code>withCount()</code> per evitare N+1<br>
            2. Carica solo le colonne necessarie con <code>select()</code><br>
            3. Usa <code>chunk()</code> per grandi dataset<br>
            4. Abilita query log per debug: <code>DB::enableQueryLog()</code>
        </div>

        <footer style="margin-top: 60px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #999;">
            <p>Laravel Eloquent Cheatsheet - Versione 2025</p>
            <p>Per maggiori info: <a href="https://laravel.com/docs/eloquent" style="color: #ff2d20;">Laravel Docs</a></p>
        </footer>
    </div>
</body>
</html>